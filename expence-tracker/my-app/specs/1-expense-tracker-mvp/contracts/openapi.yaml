openapi: 3.0.3
info:
  title: Expense Tracker API
  description: RESTful API for the Expense Tracker MVP
  version: 1.0.0
  contact:
    name: API Support
    email: support@expensetracker.example.com
servers:
  - url: https://api.expensetracker.example.com/api
    description: Production server
  - url: http://localhost:3000/api
    description: Development server

tags:
  - name: Authentication
    description: User authentication endpoints
  - name: Transactions
    description: Expense and income management
  - name: Categories
    description: Category management
  - name: Budgets
    description: Budget management
  - name: Reports
    description: Data export and reporting
  - name: User
    description: User profile and preferences

paths:
  # Authentication
  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register new user
      description: Create a new user account with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  maxLength: 255
                  example: user@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: SecurePass123
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Verification email sent
                  userId:
                    type: string
                    format: uuid
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticate user and create session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  token:
                    type: string
                    description: Session token (also set as HTTP-only cookie)
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimit'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: User logout
      description: Terminate user session
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/reset-password:
    post:
      tags:
        - Authentication
      summary: Request password reset
      description: Send password reset email to user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Reset email sent (always returns 200 to prevent email enumeration)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: If the email exists, a reset link has been sent
        '429':
          $ref: '#/components/responses/RateLimit'

  # Transactions
  /transactions:
    get:
      tags:
        - Transactions
      summary: List user transactions
      description: Get paginated list of transactions with optional filters
      security:
        - bearerAuth: []
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [EXPENSE, INCOME]
        - name: category
          in: query
          schema:
            type: string
        - name: paymentMethod
          in: query
          schema:
            type: string
            enum: [CASH, CARD, BANK_TRANSFER, OTHER]
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: List of transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Transactions
      summary: Create transaction
      description: Create a new expense or income transaction
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionInput'
      responses:
        '201':
          description: Transaction created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /transactions/{id}:
    get:
      tags:
        - Transactions
      summary: Get transaction by ID
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TransactionId'
      responses:
        '200':
          description: Transaction details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Transactions
      summary: Update transaction
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TransactionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionInput'
      responses:
        '200':
          description: Transaction updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Transactions
      summary: Delete transaction
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TransactionId'
      responses:
        '204':
          description: Transaction deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # Categories
  /categories:
    get:
      tags:
        - Categories
      summary: List categories
      description: Get all predefined and user custom categories
      security:
        - bearerAuth: []
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [EXPENSE, INCOME]
      responses:
        '200':
          description: List of categories
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Categories
      summary: Create custom category
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CategoryInput'
      responses:
        '201':
          description: Category created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Category name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /categories/{id}:
    put:
      tags:
        - Categories
      summary: Update category
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CategoryId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CategoryInput'
      responses:
        '200':
          description: Category updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Cannot modify predefined category
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Categories
      summary: Delete category
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/CategoryId'
      responses:
        '204':
          description: Category deleted
        '400':
          description: Cannot delete category with existing transactions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Cannot delete predefined category
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  # Budgets
  /budgets:
    get:
      tags:
        - Budgets
      summary: List budgets
      description: Get budgets with spending progress
      security:
        - bearerAuth: []
      parameters:
        - name: month
          in: query
          description: Filter by month (YYYY-MM-01)
          schema:
            type: string
            format: date
      responses:
        '200':
          description: List of budgets with progress
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BudgetWithProgress'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Budgets
      summary: Create budget
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BudgetInput'
      responses:
        '201':
          description: Budget created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Budget already exists for this category and month
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /budgets/{id}:
    put:
      tags:
        - Budgets
      summary: Update budget
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/BudgetId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                amount:
                  type: number
                  format: decimal
                  minimum: 0.01
                  maximum: 1000000
      responses:
        '200':
          description: Budget updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Budgets
      summary: Delete budget
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/BudgetId'
      responses:
        '204':
          description: Budget deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # Reports
  /reports/summary:
    get:
      tags:
        - Reports
      summary: Get financial summary
      description: Get aggregated spending/income summary for date range
      security:
        - bearerAuth: []
      parameters:
        - name: startDate
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          required: true
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Financial summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FinancialSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /export/csv:
    post:
      tags:
        - Reports
      summary: Export transactions to CSV
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                startDate:
                  type: string
                  format: date
                endDate:
                  type: string
                  format: date
      responses:
        '200':
          description: CSV file
          content:
            text/csv:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
                example: attachment; filename="transactions-2025-11.csv"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /export/pdf:
    post:
      tags:
        - Reports
      summary: Export report to PDF
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                startDate:
                  type: string
                  format: date
                endDate:
                  type: string
                  format: date
      responses:
        '200':
          description: PDF file
          content:
            application/pdf:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
                example: attachment; filename="report-2025-11.pdf"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /import/csv:
    post:
      tags:
        - Reports
      summary: Import transactions from CSV
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Import summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  imported:
                    type: integer
                  failed:
                    type: integer
                  errors:
                    type: array
                    items:
                      type: object
                      properties:
                        row:
                          type: integer
                        error:
                          type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # User
  /user/profile:
    get:
      tags:
        - User
      summary: Get user profile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /user/preferences:
    put:
      tags:
        - User
      summary: Update user preferences
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserPreferences'
      responses:
        '200':
          description: Preferences updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /user/delete:
    delete:
      tags:
        - User
      summary: Delete user account
      description: Permanently delete user account and all data
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Account deleted
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    TransactionId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid

    CategoryId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid

    BudgetId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        emailVerified:
          type: boolean
        preferences:
          $ref: '#/components/schemas/UserPreferences'
        createdAt:
          type: string
          format: date-time

    UserPreferences:
      type: object
      properties:
        budgetAlertsEnabled:
          type: boolean
        dailyRemindersEnabled:
          type: boolean
        reminderTime:
          type: string
          pattern: '^([01]\d|2[0-3]):([0-5]\d)$'
          nullable: true
          example: '09:00'
        notificationMethod:
          type: string
          enum: [IN_APP, EMAIL, BOTH]

    Transaction:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [EXPENSE, INCOME]
        amount:
          type: number
          format: decimal
        category:
          type: string
        date:
          type: string
          format: date
        description:
          type: string
          maxLength: 200
          nullable: true
        paymentMethod:
          type: string
          enum: [CASH, CARD, BANK_TRANSFER, OTHER]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    TransactionInput:
      type: object
      required:
        - type
        - amount
        - category
        - date
        - paymentMethod
      properties:
        type:
          type: string
          enum: [EXPENSE, INCOME]
        amount:
          type: number
          format: decimal
          minimum: 0.01
          maximum: 99999999.99
        category:
          type: string
          minLength: 1
          maxLength: 100
        date:
          type: string
          format: date
        description:
          type: string
          maxLength: 200
        paymentMethod:
          type: string
          enum: [CASH, CARD, BANK_TRANSFER, OTHER]

    Category:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        type:
          type: string
          enum: [EXPENSE, INCOME]
        isPredefined:
          type: boolean
        createdAt:
          type: string
          format: date-time

    CategoryInput:
      type: object
      required:
        - name
        - type
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        type:
          type: string
          enum: [EXPENSE, INCOME]

    Budget:
      type: object
      properties:
        id:
          type: string
          format: uuid
        categoryId:
          type: string
          format: uuid
        category:
          $ref: '#/components/schemas/Category'
        amount:
          type: number
          format: decimal
        month:
          type: string
          format: date
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    BudgetInput:
      type: object
      required:
        - categoryId
        - amount
        - month
      properties:
        categoryId:
          type: string
          format: uuid
        amount:
          type: number
          format: decimal
          minimum: 0.01
          maximum: 1000000
        month:
          type: string
          format: date
          description: First day of the month (YYYY-MM-01)

    BudgetWithProgress:
      allOf:
        - $ref: '#/components/schemas/Budget'
        - type: object
          properties:
            spent:
              type: number
              format: decimal
            remaining:
              type: number
              format: decimal
            percentage:
              type: number
              format: float
              description: Spending as percentage of budget (0-100+)
            status:
              type: string
              enum: [SAFE, WARNING, EXCEEDED]
              description: SAFE (<70%), WARNING (70-100%), EXCEEDED (>100%)

    FinancialSummary:
      type: object
      properties:
        totalExpenses:
          type: number
          format: decimal
        totalIncome:
          type: number
          format: decimal
        netBalance:
          type: number
          format: decimal
        expensesByCategory:
          type: array
          items:
            type: object
            properties:
              category:
                type: string
              amount:
                type: number
                format: decimal
              percentage:
                type: number
                format: float
        expensesByPaymentMethod:
          type: array
          items:
            type: object
            properties:
              paymentMethod:
                type: string
              amount:
                type: number
                format: decimal
              percentage:
                type: number
                format: float

    Pagination:
      type: object
      properties:
        page:
          type: integer
          minimum: 1
        limit:
          type: integer
          minimum: 1
          maximum: 100
        total:
          type: integer
        totalPages:
          type: integer

    Error:
      type: object
      properties:
        error:
          type: string
        code:
          type: string
        details:
          type: object
          nullable: true

  responses:
    BadRequest:
      description: Invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Not authenticated
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    RateLimit:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
        X-RateLimit-Remaining:
          schema:
            type: integer
        X-RateLimit-Reset:
          schema:
            type: integer
            format: unix-timestamp
